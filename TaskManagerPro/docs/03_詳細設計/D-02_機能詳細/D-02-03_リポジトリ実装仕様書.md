# D-02-03 [データ] リポジトリ実装仕様書

## 1. 概要
`SqliteTaskRepository` は、データベースへのアクセスをカプセル化するクラスである。
Entity Framework Core の `DbContext` をラップし、アプリケーション層に対してDTO/Entityの入出力のみを提供する。

## 2. メソッド仕様詳細

### 2.1 GetAllAsync
- **シグネチャ**: `Task<IEnumerable<TaskItem>> GetAllAsync()`
- **クエリ仕様**:
  - `Tasks` テーブルを全件取得。
  - `IsCompleted = 0` (未完了) のものを優先的に取得するオプションを将来的に検討。
  - **AsNoTracking**: 読み取り専用リストの場合は `AsNoTracking()` を付与してパフォーマンスを向上させる。

### 2.2 AddAsync
- **シグネチャ**: `Task AddAsync(TaskItem task)`
- **処理**:
  1. 引数の `task` を `DbContext.Tasks.Add(task)`。
  2. `DbContext.SaveChangesAsync()` を実行。
  3. 発行された `Id` が `task.Id` に設定されていることを確認。

### 2.3 UpdateAsync
- **シグネチャ**: `Task UpdateAsync(TaskItem task)`
- **処理**:
  1. `DbContext.Tasks.Update(task)`。
  2. `UpdatedAt` カラムを現在時刻に更新。
  3. `SaveChangesAsync()`。
- **例外処理**:
  - `DbUpdateConcurrencyException`: 同時更新競合時は、クライアント勝ち（後勝ち）とするか、再読み込みを促す（今回は後勝ちで実装）。

## 3. トランザクション
基本的には単一操作で完結するため、EF Coreの暗黙的トランザクション (`SaveChangesAsync`) に委ねる。
カテゴリ追加とタスク追加を同時に行う等の複合操作が必要になった場合は、`IDbContextTransaction` を使用して明示的にスコープを切る。
