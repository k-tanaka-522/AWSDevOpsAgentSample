# REQ-001: 障害シミュレーション機能 要件定義書

## 1. 概要

### 1.1 目的
AWS DevOps Agent の検証のため、意図的に遅延やエラーを発生させる障害シミュレーション機能を実装する。

### 1.2 背景
- DevOps Agent はCloudWatchアラームをトリガーに、障害の調査・分析を自動実行する
- 検証には、X-Rayトレースで可視化可能な遅延パターンが必要
- 現在の実装には技術的問題（ルーティング順序）があり、修正が必要

### 1.3 スコープ
- 既存の障害シミュレーションエンドポイントのバグ修正
- X-Ray トレースでの遅延可視化
- CloudWatch アラームとの連携

---

## 2. 現状の問題

### 2.1 技術的問題
**根本原因**: FastAPI ルーティング順序問題

```
現在の定義順序:
1. GET /tasks/{task_id}  ← 先にマッチ（パスパラメータ）
2. GET /tasks/slow-db    ← 到達不可
3. GET /tasks/slow-logic ← 到達不可
4. GET /tasks/slow-external ← 到達不可
```

**症状**: `/tasks/slow-db` にアクセスすると、`slow-db` が UUID として解釈され 500 エラー

### 2.2 修正方針
静的パス（`/slow-db` 等）をパスパラメータ（`/{task_id}`）より**先に**定義する

---

## 3. 機能要件

### 3.1 障害シミュレーションエンドポイント

| エンドポイント | 遅延種別 | 遅延時間 | 用途 |
|---------------|---------|---------|------|
| `GET /tasks/slow-db` | データベース遅延 | 3秒 | RDS クエリ遅延の検出 |
| `GET /tasks/slow-logic` | アプリケーション遅延 | 5秒 | 処理ロジック遅延の検出 |
| `GET /tasks/slow-external` | 外部API遅延 | 2秒 | 外部依存の遅延検出 |
| `GET /tasks/error` | エラー発生 | - | 500エラーの検出 |

### 3.2 各エンドポイントの詳細

#### 3.2.1 GET /tasks/slow-db
- **目的**: データベースクエリの遅延をシミュレート
- **実装方法**: PostgreSQL `pg_sleep(3)` 関数を使用
- **レスポンス**:
  ```json
  {
    "status": "success",
    "delay_type": "database",
    "delay_seconds": 3,
    "message": "Database delay simulation completed"
  }
  ```

#### 3.2.2 GET /tasks/slow-logic
- **目的**: アプリケーション処理の遅延をシミュレート
- **実装方法**: `asyncio.sleep(5)` を使用
- **レスポンス**:
  ```json
  {
    "status": "success",
    "delay_type": "application_logic",
    "delay_seconds": 5,
    "message": "Application logic delay simulation completed"
  }
  ```

#### 3.2.3 GET /tasks/slow-external
- **目的**: 外部API呼び出しの遅延をシミュレート
- **実装方法**: httpx で `httpbin.org/delay/2` を呼び出し
- **レスポンス**:
  ```json
  {
    "status": "success",
    "delay_type": "external_api",
    "delay_seconds": 2,
    "external_url": "https://httpbin.org/delay/2",
    "message": "External API delay simulation completed"
  }
  ```

#### 3.2.4 GET /tasks/error
- **目的**: 意図的なエラー発生
- **実装方法**: 500 Internal Server Error を返す
- **レスポンス**:
  ```json
  {
    "detail": "Intentional error for testing purposes"
  }
  ```

---

## 4. 非機能要件

### 4.1 X-Ray トレース要件

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| NFR-001 | 各遅延がX-Ray サブセグメントとして記録されること | 必須 |
| NFR-002 | データベース遅延は `namespace="remote"` で記録されること | 必須 |
| NFR-003 | X-Ray Service Map で遅延箇所が視覚的に識別できること | 必須 |
| NFR-004 | 遅延時間がサブセグメントの duration として正確に記録されること | 必須 |

### 4.2 CloudWatch アラーム連携要件

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| NFR-005 | TargetResponseTime が閾値（1秒）を超えた場合にアラーム発火 | 必須 |
| NFR-006 | 5XXCount が閾値を超えた場合にアラーム発火 | 必須 |
| NFR-007 | アラームがSNSトピックに通知されること | 必須 |

### 4.3 DevOps Agent 検証要件

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| NFR-008 | DevOps Agent がアラームをトリガーに調査を開始できること | 必須 |
| NFR-009 | X-Ray トレースから遅延原因が特定できること | 必須 |
| NFR-010 | GitHub Issue が自動作成されること（DevOps Agent機能） | 推奨 |

---

## 5. 技術的制約

### 5.1 ルーティング順序
FastAPI では**先に定義されたルートが優先**される。静的パスは動的パスより先に定義すること。

```python
# 正しい順序
@router.get("/slow-db")      # 1. 静的パス（先）
@router.get("/slow-logic")   # 2. 静的パス
@router.get("/{task_id}")    # 3. 動的パス（後）
```

### 5.2 X-Ray SDK
- `aws-xray-sdk` を使用
- データベースクエリは `xray_recorder.capture()` でラップ
- `namespace="remote"` を指定してService Mapに表示

---

## 6. 受け入れ基準

### 6.1 機能テスト
- [ ] `GET /tasks/slow-db` が200を返し、約3秒で完了する
- [ ] `GET /tasks/slow-logic` が200を返し、約5秒で完了する
- [ ] `GET /tasks/slow-external` が200を返し、約2秒で完了する
- [ ] `GET /tasks/error` が500を返す

### 6.2 X-Ray 検証
- [ ] 各エンドポイントのトレースがX-Ray Consoleで確認できる
- [ ] Service Mapで遅延箇所が色分け表示される
- [ ] サブセグメントに遅延時間が正確に記録されている

### 6.3 CloudWatch アラーム検証
- [ ] 遅延エンドポイント呼び出し後、TargetResponseTimeアラームが発火する
- [ ] エラーエンドポイント呼び出し後、5XXCountアラームが発火する

---

## 7. 関連ドキュメント

- 試験計画書: `.claude-state/test-plan/devops-agent-validation.md`
- 基本設計書: `docs/03_基本設計/`
- API仕様書: `docs/04_詳細設計/06_api_specification.md`

---

## 8. 変更履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|-----------|---------|------|
| 2025-12-14 | 1.0 | 初版作成 | PM |
