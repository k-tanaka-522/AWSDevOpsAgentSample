# X-Ray Watch POC 要件定義書

## 1. はじめに

### 1.1 目的
本ドキュメントは、X-Ray Watch POCの機能要件・非機能要件を定義する。

### 1.2 スコープ
- **対象**: POC Phase 1（基本的な監視・トレーシング検証）
- **対象外**: Phase 2以降の検証項目（Hinemos代替、SESメール、OpenSearch等）

### 1.3 参照ドキュメント
- [企画書](../01_企画/企画書.md)

---

## 2. プロジェクト概要（企画書より）

| 項目 | 内容 |
|------|------|
| プロジェクト名 | X-Ray Watch POC |
| 目的 | AWS環境での監視・品質管理・AI活用の実現可能性検証 |
| 予算 | 月1,000円程度 |
| 運用方針 | IaC（CloudFormation）でスクラップ&ビルド |

---

## 3. 機能要件

### 3.1 タスク管理API（CRUD）

サンプルアプリケーションとして、シンプルなタスク管理APIを実装する。

#### 3.1.1 データモデル

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | UUID | タスクID（自動生成） |
| title | String | タスク名 |
| description | String | 詳細説明（任意） |
| status | Enum | pending / in_progress / completed |
| created_at | DateTime | 作成日時 |
| updated_at | DateTime | 更新日時 |

#### 3.1.2 APIエンドポイント

| メソッド | エンドポイント | 説明 |
|----------|---------------|------|
| GET | /tasks | タスク一覧取得 |
| GET | /tasks/{id} | タスク詳細取得 |
| POST | /tasks | タスク作成 |
| PUT | /tasks/{id} | タスク更新 |
| DELETE | /tasks/{id} | タスク削除 |

### 3.2 障害シミュレーションAPI

X-Ray検証用に、意図的に遅延を発生させるAPIを実装する。

| メソッド | エンドポイント | 説明 | 遅延方法 |
|----------|---------------|------|----------|
| GET | /tasks/slow-db | DB遅延シミュレーション | `pg_sleep(3)` |
| GET | /tasks/slow-logic | ロジック遅延シミュレーション | `time.sleep(5)` |
| GET | /tasks/slow-external | 外部API遅延シミュレーション | モック外部APIに遅延 |

### 3.3 ヘルスチェックAPI

| メソッド | エンドポイント | 説明 |
|----------|---------------|------|
| GET | /health | ヘルスチェック |

---

## 4. 非機能要件

### 4.1 性能要件

| 項目 | 目標値 | 備考 |
|------|--------|------|
| 通常APIレスポンス | 1秒以内 | 遅延シミュレーションAPI除く |
| 同時接続数 | 10程度 | POC検証レベル |

### 4.2 可用性要件

| 項目 | 目標値 | 備考 |
|------|--------|------|
| 稼働時間 | 検証時のみ | スクラップ&ビルド運用 |
| 冗長化 | なし | POCのため単一AZ |

### 4.3 セキュリティ要件

| 項目 | 要件 | 備考 |
|------|------|------|
| 認証 | なし | POCのため簡略化 |
| 通信 | HTTPS | API Gateway標準 |
| シークレット | Secrets Manager | DB認証情報等 |

### 4.4 監視要件

| 項目 | 要件 | 備考 |
|------|------|------|
| 分散トレーシング | X-Ray | 全APIリクエストをトレース |
| メトリクス監視 | CloudWatch | ECS、RDS、API Gateway |
| ログ | CloudWatch Logs | アプリケーションログ |

### 4.5 アラート要件

| 条件 | 閾値 | 通知先 |
|------|------|--------|
| APIレスポンス遅延 | 3秒以上 | SNS → メール |
| エラー率 | 10%以上 | SNS → メール |
| ECS CPU使用率 | 80%以上 | SNS → メール |

---

## 5. システム構成

### 5.1 構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                           AWS Cloud                             │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                         VPC                               │  │
│  │  ┌─────────────┐                                         │  │
│  │  │   Public    │                                         │  │
│  │  │   Subnet    │                                         │  │
│  │  │ ┌─────────┐ │                                         │  │
│  │  │ │   NAT   │ │                                         │  │
│  │  │ │ Gateway │ │                                         │  │
│  │  │ └─────────┘ │                                         │  │
│  │  └─────────────┘                                         │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────────┐ │  │
│  │  │                  Private Subnet                      │ │  │
│  │  │  ┌─────────────┐         ┌─────────────┐            │ │  │
│  │  │  │    ECS      │────────▶│    RDS      │            │ │  │
│  │  │  │  (Python)   │         │ (PostgreSQL)│            │ │  │
│  │  │  │  + X-Ray    │         │             │            │ │  │
│  │  │  └─────────────┘         └─────────────┘            │ │  │
│  │  └─────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────┘  │
│           ▲                                                    │
│           │                                                    │
│  ┌────────┴────────┐                                          │
│  │   API Gateway   │◀─── Internet                             │
│  │   (HTTP API)    │                                          │
│  └─────────────────┘                                          │
│           │                                                    │
│           ▼                                                    │
│  ┌─────────────────┐    ┌─────────────┐    ┌──────────────┐  │
│  │     X-Ray       │───▶│ CloudWatch  │───▶│     SNS      │  │
│  │  (トレーシング)  │    │  (アラート)  │    │   (通知)     │  │
│  └─────────────────┘    └─────────────┘    └──────────────┘  │
│                                                    │           │
│  ┌─────────────────────────────────────────────────┼─────────┐│
│  │              AWS DevOps Agent                   ▼         ││
│  │         (AI調査・GitHub Issue連携)          メール通知    ││
│  └───────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│  GitHub Repository                      │
│  k-tanaka-522/AWSDevOpsAgentSample      │
│  (Issue自動起票)                         │
└─────────────────────────────────────────┘
```

### 5.2 技術スタック

| レイヤー | 技術 | 備考 |
|----------|------|------|
| API Gateway | HTTP API | REST API より低コスト |
| コンピューティング | ECS Fargate | サーバーレス、最小構成 |
| 言語/FW | Python + FastAPI | シンプル、X-Ray SDK対応 |
| DB | RDS PostgreSQL | db.t3.micro（最小） |
| トレーシング | AWS X-Ray | Python SDK使用 |
| 監視 | CloudWatch | メトリクス、ログ、アラーム |
| 通知 | SNS | メール通知 |
| AI | AWS DevOps Agent | GitHub連携 |
| IaC | CloudFormation | 後でTerraform化 |

### 5.3 GitHub連携

| 項目 | 内容 |
|------|------|
| リポジトリ | https://github.com/k-tanaka-522/AWSDevOpsAgentSample.git |
| 用途 | AWS DevOps AgentによるIssue自動起票検証 |

---

## 6. 検証シナリオ

### 6.1 X-Ray遅延検知検証

| # | シナリオ | 手順 | 期待結果 |
|---|----------|------|----------|
| 1 | DB遅延検知 | `/tasks/slow-db` を呼び出す | X-Rayで「DB処理に3秒」と表示 |
| 2 | ロジック遅延検知 | `/tasks/slow-logic` を呼び出す | X-Rayで「処理ロジックに5秒」と表示 |
| 3 | 外部API遅延検知 | `/tasks/slow-external` を呼び出す | X-Rayで「外部呼出に遅延」と表示 |

### 6.2 CloudWatchアラート検証

| # | シナリオ | 手順 | 期待結果 |
|---|----------|------|----------|
| 1 | 遅延アラート | 遅延APIを複数回呼び出す | SNSからメール通知受信 |
| 2 | エラーアラート | 意図的に500エラーを発生 | SNSからメール通知受信 |

### 6.3 AWS DevOps Agent検証

| # | シナリオ | 手順 | 期待結果 |
|---|----------|------|----------|
| 1 | Issue自動起票 | アラート発生時にAgent起動 | GitHubにIssueが作成される |

---

## 7. コスト見積もり

### 7.1 主要コスト項目（検証時のみ稼働）

| サービス | 見積もり | 備考 |
|----------|----------|------|
| ECS Fargate | 約300円/月 | 0.25vCPU, 0.5GB, 数時間/日 |
| RDS | 約400円/月 | db.t3.micro, 数時間/日 |
| NAT Gateway | 約100円/月 | 最小利用 |
| API Gateway | 約10円/月 | HTTP API, 少量リクエスト |
| X-Ray | 無料枠内 | 10万トレース/月無料 |
| CloudWatch | 無料枠内 | 基本メトリクス無料 |
| SNS | 無料枠内 | 1,000通知/月無料 |
| **合計** | **約800-1,000円/月** | 検証時のみ稼働前提 |

### 7.2 コスト削減ポイント

- 検証終了後は即座にリソース削除
- RDSは検証時のみ起動（最もコスト影響大）
- NAT Gatewayの利用を最小限に

---

## 8. 制約事項

| # | 制約 | 理由 |
|---|------|------|
| 1 | 認証機能なし | POCのため簡略化 |
| 2 | 単一AZ構成 | コスト削減 |
| 3 | 最小スペック | 月1,000円予算内 |
| 4 | アプリはサンプル品質 | インフラ検証が目的 |

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| X-Ray | AWSの分散トレーシングサービス |
| CloudWatch | AWSの監視サービス |
| SNS | Simple Notification Service、通知サービス |
| ECS Fargate | サーバーレスコンテナ実行環境 |
| AWS DevOps Agent | AIによる運用支援サービス |

---

## 10. 承認

| 役割 | 承認者 | 日付 |
|------|--------|------|
| プロジェクトオーナー | | |

---

**作成者**: Claude (AI開発ファシリテーター)
**作成日**: 2025-12-10
