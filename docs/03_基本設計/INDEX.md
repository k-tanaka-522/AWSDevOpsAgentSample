# X-Ray Watch POC - 基本設計書 INDEX

## プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | X-Ray Watch POC |
| 目的 | X-Ray/CloudWatch/DevOps Agentの技術検証、オンプレ→AWS移行判断材料収集 |
| スコープ | POC環境構築（スクラップ&ビルド運用） |
| 予算 | 月額1,000円程度（$7-10）<br/>※検証時のみ起動（月20時間程度） |
| 期間 | 1-2ヶ月（検証完了まで） |

## ドキュメント構成

### インフラ設計（infra-architect担当）

| # | ドキュメント | 概要 | レビュー状況 |
|---|------------|------|-------------|
| 1 | [01_システムアーキテクチャ.md](01_システムアーキテクチャ.md) | 全体構成図、システム構成要素 | ✅ シンプル構成に更新 |
| 2 | [02_ネットワーク設計.md](02_ネットワーク設計.md) | VPC、サブネット、ルーティング（NAT Gateway削除） | ✅ シンプル構成に更新 |
| 3 | [03_セキュリティ設計.md](03_セキュリティ設計.md) | Security Groups、IAM、暗号化 | ✅ 作成完了 |
| 4 | [04_監査・コンプライアンス設計.md](04_監査・コンプライアンス設計.md) | ログ保管、証跡管理 | ✅ 作成完了 |
| 5 | [05_データベース設計.md](05_データベース設計.md) | RDS構成、バックアップ戦略 | ✅ 作成完了 |
| 6 | [06_コンピュート設計.md](06_コンピュート設計.md) | ECS、ALB（NLB削除） | ✅ シンプル構成に更新 |
| 7 | [07_フロントエンド配信設計.md](07_フロントエンド配信設計.md) | API Gateway削除（ALB直接公開） | ✅ シンプル構成に更新 |
| 8 | [08_監視・アラート設計.md](08_監視・アラート設計.md) | X-Ray、CloudWatch、SNS、DevOps Agent | ✅ 作成完了 |
| 9 | [09_CI_CD設計.md](09_CI_CD設計.md) | GitHub Actions、OIDC、デプロイ戦略 | ✅ 作成完了 |
| 10 | [10_IaC構成方針.md](10_IaC構成方針.md) | CloudFormation ディレクトリ構造、スタック分割簡素化 | ✅ シンプル構成に更新 |
| 11 | [11_非機能要件実現方針.md](11_非機能要件実現方針.md) | 性能、可用性、セキュリティ、監視性 | ✅ 作成完了 |
| 12 | [12_災害対策・BCP.md](12_災害対策・BCP.md) | DR、バックアップ、RTO/RPO | ✅ 作成完了 |
| 13 | [13_コスト設計.md](13_コスト設計.md) | 月額見積もり（スクラップ&ビルド前提） | ✅ シンプル構成に更新 |

## 重要な設計判断（ADR サマリー）

### ADR-001: POC向け単一AZ構成の採用
- **決定**: 単一AZ構成を採用
- **理由**: コスト最優先、POCのため可用性より検証優先
- **影響**: Multi-AZ構成は本格導入時に検討

### ADR-002: IaCツールにCloudFormationを採用
- **決定**: AWS CloudFormation を採用
- **理由**: AWSネイティブ、追加コスト不要、POCから本番への移行容易
- **影響**: Terraformは不採用

### ADR-003: 認証なしのパブリックアクセス許容
- **決定**: POC期間中は認証機能を実装しない
- **理由**: 検証簡略化、開発コスト削減
- **影響**: 本格導入時に認証機能を追加（Cognito、API Key等）

### ADR-004: NAT Gateway削除（シンプル構成採用）
- **決定**: ECSをパブリックサブネットに配置、NAT Gateway削除
- **理由**: コスト削減（月額$45削減）、POCでは外部アクセス制限不要
- **影響**: ECSがパブリックIPを持つ、セキュリティ簡素化

### ADR-005: API Gateway削除（ALB直接公開）
- **決定**: API Gateway不使用、ALB直接公開
- **理由**: コスト削減（API Gateway + NLB合計$22削減）、POCでは高度なAPI機能不要
- **影響**: API管理機能（レート制限、認証等）なし

### ADR-006: スクラップ&ビルド運用
- **決定**: 検証時のみインフラ起動、検証後即削除
- **理由**: コスト最小化（月20時間稼働想定）
- **影響**: 24時間稼働しない、再起動に数分必要

## POC特有の制約事項

| 制約項目 | 内容 | 理由 |
|---------|------|------|
| 予算 | 月額1,000円程度（$7-10）<br/>**※スクラップ&ビルド運用前提** | 検証時のみ起動（月20時間） |
| 可用性 | 単一AZ許容 | コスト削減、検証優先 |
| セキュリティ | 認証なし、パブリックアクセス許容 | 検証簡略化 |
| 運用 | スクラップ&ビルド（検証時のみ起動） | コスト最小化 |

## コスト内訳（月額$7-10想定、月20時間稼働）

| カテゴリ | サービス | 月額（USD） | 割合 |
|---------|---------|-----------|------|
| コンピュート | ALB | $0.65 | 30% |
| コンピュート | ECS Fargate | $0.28 | 13% |
| データベース | RDS PostgreSQL | $0.49 | 23% |
| 監視 | CloudWatch | $0.70 | 32% |
| その他 | データ転送、X-Ray、ECR | $0.05 | 2% |
| **合計** | | **$2.17** | **100%** |

**注**: 上記は月20時間稼働時の見積もり。24時間稼働の場合は約$30-40/月。

## 技術スタック

| レイヤー | 技術 | バージョン |
|---------|------|----------|
| IaC | AWS CloudFormation | - |
| コンテナ | Docker | 最新 |
| ランタイム | ECS Fargate | 最新プラットフォーム |
| データベース | PostgreSQL | 15.x |
| 監視 | X-Ray + CloudWatch + DevOps Agent | - |
| CI/CD | GitHub Actions | - |
| 認証 | なし（POC簡略化） | 本番時: Cognito |

## システム構成の簡素化

### 削除したコンポーネント
- **NAT Gateway**: ECSをパブリックサブネット配置により不要
- **NLB**: API Gateway削除により不要
- **API Gateway**: ALB直接公開により不要

### 新しい構成
```
Internet → ALB → ECS Fargate (Python+X-Ray) → RDS
                      ↓
              CloudWatch → SNS → メール
                      ↓
              AWS DevOps Agent → GitHub Issue
```

### 簡素化のメリット
1. **コスト削減**: NAT Gateway（$45/月）+ NLB（$22/月）+ API Gateway（$0.5/月）= 約$67/月削減
2. **構成シンプル**: コンポーネント数削減、トラブルシューティング容易
3. **検証に十分**: X-Ray検証にはECS + ALB構成で十分

### 簡素化のトレードオフ
1. **セキュリティ**: ECSがパブリックIP保有（POCでは許容）
2. **API管理機能なし**: レート制限、認証等なし（POCでは不要）
3. **外部サービス連携制限**: Privateサブネット経由の外部API呼び出し不可（POCでは不要）

## 本格導入への移行考慮事項

POC成功後、以下を本格導入時に追加検討:

### Phase 1: セキュリティ強化
- Privateサブネット配置 + NAT Gateway復活
- 認証・認可（Cognito、API Key）
- API Gateway追加（レート制限、リクエスト変換）

### Phase 2: Multi-AZ化（コスト約3倍）
- Multi-AZ構成（RDS、ALB、ECS）
- NAT Gateway 2個（各AZ）
- 可用性99.95%目標

### Phase 3: スケーラビリティ
- Auto Scaling（ECS: 2-10タスク）
- CloudFront（CDN）
- Read Replica（RDS）

**本番環境想定コスト**: $300-500/月

## レビュー・承認

- 設計者: infra-architect
- レビュー担当者: SRE、Consultant
- 承認者: PM、ユーザー
- 承認日: 未定

## セルフチェック結果

### 技術標準準拠
- [x] ディレクトリ構成: stacks/templates/parameters 分離記載（10_IaC構成方針.md）
- [x] 環境差分管理: パラメータファイルで管理方針記載（10_IaC構成方針.md）
- [x] セキュリティ: Security Groups、暗号化設計含む（03_セキュリティ設計.md）

### 要件定義との整合性
- [x] 可用性要件: Single-AZ 設計（POC向け簡素化）
- [x] セキュリティ要件: 基本的な保護、認証なし（POC向け簡素化）
- [x] コスト要件: 月額1,000円目標（スクラップ&ビルド運用で達成可能）

### 設計書間の整合性
- [x] VPC CIDR ↔ サブネット設計: 整合（10.0.0.0/16）
- [x] infra設計内の整合性: ネットワーク、セキュリティ、コンピュート整合確認済み

### 作成ファイル一覧
- docs/03_基本設計/INDEX.md
- docs/03_基本設計/01_システムアーキテクチャ.md
- docs/03_基本設計/02_ネットワーク設計.md
- docs/03_基本設計/03_セキュリティ設計.md
- docs/03_基本設計/04_監査・コンプライアンス設計.md
- docs/03_基本設計/05_データベース設計.md
- docs/03_基本設計/06_コンピュート設計.md
- docs/03_基本設計/07_フロントエンド配信設計.md
- docs/03_基本設計/08_監視・アラート設計.md
- docs/03_基本設計/09_CI_CD設計.md
- docs/03_基本設計/10_IaC構成方針.md
- docs/03_基本設計/11_非機能要件実現方針.md
- docs/03_基本設計/12_災害対策・BCP.md
- docs/03_基本設計/13_コスト設計.md

### レビュー依頼
PMレビューをお願いします。

## 変更履歴

| 日付 | 版 | 変更内容 | 担当者 |
|------|---|---------|--------|
| 2025-12-10 | 1.0 | 初版作成（13ファイル完成） | infra-architect |
| 2025-12-10 | 1.1 | シンプル構成に変更（NAT Gateway、NLB、API Gateway削除） | infra-architect |
