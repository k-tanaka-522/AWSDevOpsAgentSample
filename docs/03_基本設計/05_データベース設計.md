# データベース設計

## データベース設計方針

### POC向け最小構成

| 項目 | POC方針 | 本番環境での追加 |
|------|---------|----------------|
| 冗長化 | Single-AZ | Multi-AZ（自動フェイルオーバー） |
| インスタンスタイプ | db.t4g.micro（最小構成） | db.t4g.small以上 |
| ストレージ | 20GB（汎用SSD） | 100GB以上、Provisioned IOPS |
| バックアップ | 自動バックアップ7日間 | 自動バックアップ30日間 + 手動スナップショット |
| リードレプリカ | なし | 読み取り負荷分散用に追加 |
| パフォーマンスInsights | なし（コスト削減） | 有効化 |

## RDS PostgreSQL構成

### インスタンス仕様

| 項目 | 値 | 備考 |
|------|---|------|
| エンジン | PostgreSQL | - |
| バージョン | 15.x（最新マイナーバージョン） | 自動マイナーバージョンアップ有効 |
| インスタンスクラス | db.t4g.micro | 2vCPU、1GB RAM |
| マルチAZ | 無効 | POC期間中はコスト削減 |
| ストレージタイプ | 汎用SSD（gp3） | - |
| ストレージ容量 | 20GB | 最小設定 |
| ストレージ自動拡張 | 有効 | 最大100GBまで |

### 構成図

```mermaid
graph TB
    subgraph "VPC: 10.0.0.0/16"
        subgraph "Private Subnet: 10.0.11.0/24"
            ECS1[ECS Task 1]
            ECS2[ECS Task 2]
        end

        subgraph "DB Subnet: 10.0.21.0/24 (ap-northeast-1a)"
            RDS[RDS PostgreSQL<br/>db.t4g.micro<br/>Single-AZ]
        end
    end

    subgraph "S3 (AWS管理)"
        Backup[自動バックアップ<br/>7日間保持]
    end

    ECS1 -->|PostgreSQL:5432<br/>TLS接続| RDS
    ECS2 -->|PostgreSQL:5432<br/>TLS接続| RDS
    RDS -.自動バックアップ.-> Backup

    style RDS fill:#3b48cc
    style Backup fill:#569a31
```

## ネットワーク設定

### サブネットグループ

**名前**: `xray-poc-db-subnet-group`

| サブネット | AZ | CIDR |
|----------|-----|------|
| xray-poc-db-1a | ap-northeast-1a | 10.0.21.0/24 |

**注**: Single-AZ構成のため、サブネットは1つのみ

### セキュリティグループ

**名前**: `xray-poc-rds-sg`

| 方向 | プロトコル | ポート | 送信元/送信先 | 用途 |
|------|-----------|--------|--------------|------|
| **Inbound** | TCP | 5432 | xray-poc-ecs-sg | ECSからのPostgreSQL接続 |

詳細は [03_セキュリティ設計.md](03_セキュリティ設計.md) 参照

### パブリックアクセス

**設定**: 無効（Publicly Accessible: No）

**理由**:
- セキュリティ強化（インターネットからの直接アクセス不可）
- VPC内のECSからのみアクセス可能

## データベース設定

### PostgreSQL パラメータグループ

**名前**: `xray-poc-postgres15-params`

**カスタムパラメータ**:

| パラメータ名 | 値 | 理由 |
|------------|---|------|
| `rds.force_ssl` | 1 | TLS接続強制（セキュリティ強化） |
| `log_statement` | `ddl` | DDL文のみログ出力（コスト削減） |
| `log_min_duration_statement` | 1000 | 1秒以上のクエリをログ出力 |
| `shared_preload_libraries` | `pg_stat_statements` | クエリ統計取得 |
| `max_connections` | 100 | デフォルト（db.t4g.microの上限） |

**注**: POCではパフォーマンスチューニングは最小限

### オプショングループ

**名前**: デフォルトオプショングループ使用

**理由**: POCでは拡張機能不要

## 認証・接続設定

### マスターユーザー

| 項目 | 値 | 備考 |
|------|---|------|
| ユーザー名 | `postgres` | デフォルト |
| パスワード | AWS Secrets Manager管理 | 自動ローテーション無効（POC） |
| 認証方法 | パスワード認証 | IAM認証は本番環境で検討 |

### アプリケーション用ユーザー

**作成方法**: 初回デプロイ時にマイグレーションスクリプトで作成

```sql
-- アプリケーション用ユーザー作成
CREATE USER app_user WITH PASSWORD 'secure_password';

-- データベース作成
CREATE DATABASE xray_poc_db OWNER app_user;

-- 権限付与
GRANT ALL PRIVILEGES ON DATABASE xray_poc_db TO app_user;
```

### 接続文字列

**フォーマット**:
```
postgresql://app_user:password@xray-poc-rds.xxxxx.ap-northeast-1.rds.amazonaws.com:5432/xray_poc_db?sslmode=require
```

**環境変数**:
- `DB_HOST`: RDSエンドポイント（CloudFormationから出力）
- `DB_PORT`: 5432
- `DB_NAME`: xray_poc_db
- `DB_USER`: app_user
- `DB_PASSWORD`: AWS Secrets Managerから取得

## バックアップ設計

### 自動バックアップ

| 設定項目 | 値 | 備考 |
|---------|---|------|
| バックアップ保持期間 | 7日間 | POC最小設定 |
| バックアップウィンドウ | 18:00-19:00 JST (09:00-10:00 UTC) | アクセス少ない時間帯 |
| コピー先リージョン | なし | POCではコスト削減 |

### ポイントインタイムリカバリ（PITR）

**設定**: 有効（自動バックアップ有効時にデフォルト有効）

**リカバリ可能期間**: 最大7日間

**リストア方法**:
```bash
# AWS CLI
aws rds restore-db-instance-to-point-in-time \
  --source-db-instance-identifier xray-poc-rds \
  --target-db-instance-identifier xray-poc-rds-restored \
  --restore-time 2025-12-10T12:00:00Z
```

### 手動スナップショット（オプション）

**用途**: 重要なマイルストーン時のバックアップ

**作成方法**:
```bash
# AWS CLI
aws rds create-db-snapshot \
  --db-instance-identifier xray-poc-rds \
  --db-snapshot-identifier xray-poc-milestone-20251210
```

**保持期間**: 無期限（手動削除が必要）

## メンテナンス設定

### メンテナンスウィンドウ

| 設定項目 | 値 | 備考 |
|---------|---|------|
| メンテナンスウィンドウ | 日曜 19:00-20:00 JST (10:00-11:00 UTC) | アクセス少ない時間帯 |
| 自動マイナーバージョンアップグレード | 有効 | セキュリティパッチ自動適用 |

### メジャーバージョンアップグレード

**方針**: 手動実行（Blue/Green Deployment推奨）

**手順**:
1. 手動スナップショット作成
2. スナップショットから新インスタンス作成（新バージョン）
3. アプリケーション接続先変更
4. 動作確認
5. 旧インスタンス削除

## モニタリング設定

### CloudWatch メトリクス

| メトリクス | 説明 | アラーム閾値 |
|-----------|------|------------|
| `CPUUtilization` | CPU使用率 | > 80% |
| `FreeableMemory` | 空きメモリ | < 200MB |
| `FreeStorageSpace` | 空きストレージ | < 2GB |
| `DatabaseConnections` | 接続数 | > 80 |
| `ReadLatency` | 読み取りレイテンシ | > 100ms |
| `WriteLatency` | 書き込みレイテンシ | > 100ms |

### 拡張モニタリング

**設定**: 無効（コスト削減）

**理由**: POC期間中は基本メトリクスで十分

**本番環境**: 有効化推奨（1秒間隔でOSメトリクス取得）

### Performance Insights

**設定**: 無効（コスト削減）

**理由**: POC期間中はクエリ分析不要

**本番環境**: 有効化推奨（ボトルネック検出）

## ログ設定

### PostgreSQLログ

**有効化するログ**:

| ログタイプ | 送信先 | 保持期間 |
|----------|--------|---------|
| `postgresql` | CloudWatch Logs | 7日間 |

**ログ内容**:
- DDL文（CREATE、ALTER、DROP）
- 1秒以上のスロークエリ
- エラーログ

**CloudWatch Logsロググループ**: `/aws/rds/instance/xray-poc-rds/postgresql`

### ログクエリ例（CloudWatch Logs Insights）

**スロークエリ抽出**:
```
fields @timestamp, @message
| filter @message like /duration:/
| parse @message /duration: (?<duration>\d+\.\d+) ms/
| filter duration > 1000
| sort duration desc
| limit 20
```

## データ移行計画

### 初期セットアップ

**マイグレーションツール**: Flyway または Liquibase

**手順**:
1. RDSインスタンス起動
2. マスターユーザーで接続
3. アプリケーション用ユーザー・DB作成
4. スキーママイグレーション実行（Flyway）
5. 初期データ投入（オプション）

### POC終了時のデータエクスポート（オプション）

**用途**: 本番環境への移行時のデータ参照

**エクスポート方法**:
```bash
# pg_dump経由でエクスポート
pg_dump -h xray-poc-rds.xxxxx.ap-northeast-1.rds.amazonaws.com \
        -U app_user -d xray_poc_db -F c -f xray_poc_backup.dump
```

## コスト見積もり

### RDS PostgreSQL db.t4g.micro

| 項目 | 単価 | 使用量 | 月額 |
|------|------|--------|------|
| インスタンス（オンデマンド） | $0.018/時間 | 730時間/月 | $13.14 |
| ストレージ（gp3） | $0.138/GB/月 | 20GB | $2.76 |
| バックアップストレージ | $0.095/GB/月 | 20GB（RDS容量と同じ） | $0（1x無料） |
| **合計** | - | - | **$15.90/月** |

**注**: 東京リージョン（ap-northeast-1）の料金

詳細は [13_コスト設計.md](13_コスト設計.md) 参照

## 本格導入時の拡張計画

### Multi-AZ構成

```mermaid
graph TB
    subgraph "ap-northeast-1a"
        Primary[Primary DB]
    end

    subgraph "ap-northeast-1c"
        Standby[Standby DB<br/>同期レプリケーション]
    end

    Primary -.同期レプリケーション.-> Standby
    Primary -->|障害時| Failover[自動フェイルオーバー]
    Failover --> Standby

    style Primary fill:#3b48cc
    style Standby fill:#3b48cc
```

**追加コスト**: 約2倍（インスタンス費用、ストレージ費用が2倍）

### リードレプリカ

**用途**: 読み取り負荷分散、レポート生成

**構成**:
- Primary: 書き込み専用
- Read Replica 1: 読み取り専用（アプリケーション）
- Read Replica 2: 読み取り専用（レポート生成）

### Performance Insights

**用途**:
- クエリパフォーマンス分析
- ボトルネック検出
- インデックス最適化

**コスト**: $0.04/vCPU/時間（db.t4g.micro: 2vCPU → $58.4/月）

## トラブルシューティング

### よくある問題と対処法

| 問題 | 原因 | 対処法 |
|------|------|--------|
| 接続できない | Security Group設定ミス | ECS SGからの5432許可確認 |
| 接続タイムアウト | VPC設定ミス | サブネットルーティング確認 |
| SSL接続エラー | `sslmode`設定ミス | `sslmode=require`設定 |
| ストレージ不足 | データ増加 | 自動拡張設定確認、手動拡張 |
| CPU使用率高 | スロークエリ | CloudWatch Logsで特定、最適化 |

### 接続テスト

**psqlからの接続**:
```bash
# ECSタスク内から実行
psql "postgresql://app_user:password@xray-poc-rds.xxxxx.ap-northeast-1.rds.amazonaws.com:5432/xray_poc_db?sslmode=require"
```

**接続確認クエリ**:
```sql
-- バージョン確認
SELECT version();

-- 現在の接続数
SELECT count(*) FROM pg_stat_activity;

-- データベース一覧
\l

-- テーブル一覧
\dt
```

## 参照ドキュメント

- [03_セキュリティ設計.md](03_セキュリティ設計.md) - Security Groups詳細
- [04_監査・コンプライアンス設計.md](04_監査・コンプライアンス設計.md) - バックアップ監査
- [08_監視・アラート設計.md](08_監視・アラート設計.md) - CloudWatchアラーム詳細
- [13_コスト設計.md](13_コスト設計.md) - RDSコスト詳細
